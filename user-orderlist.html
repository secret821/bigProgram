<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="static/css/admin.css" rel="stylesheet" type="text/css">
    <link href="static/css/amazeui.css" rel="stylesheet" type="text/css">
    <link href="static/css/personal.css" rel="stylesheet" type="text/css">
    <link href="static/css/demo.css" rel="stylesheet" type="text/css">
    <link href="static/css/systyle.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="static/css/bootstrap.css"/>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <link rel="stylesheet" href="//unpkg.com/layui@2.6.5/dist/css/layui.css">
    <script src="//unpkg.com/layui@2.6.5/dist/layui.js"></script>
    <script type="text/javascript" src="static/js/bootstrap.js"></script>
    <STYLE type="text/css">
        .cart_num {
            margin-top: -60px;
            margin-left: 100px;
        }
    </STYLE>
</head>

<body>

<div id="container">
    <div class="m-order" style="margin-bottom: 0px;">
        <div class="s-bar"><i class="s-icon"></i>我的订单
            <a href="user-orderlist.html" class="i-load-more-item-shadow">全部订单</a>
        </div>
        <ul>
            <li style="width: 25%;">
                <a @click="queryByStatus(1)"><i><img src="static/images/pay.png"></i> <span>待付款
					<p class="cart_num">{{count1}}</p></span></a>
            </li>
            <li style="width: 25%;">
                <a @click="queryByStatus(2)"><i><img src="static/images/send.png"></i> <span>待发货<p
                        class="cart_num">{{count2}}</p></span></a>
            </li>
            <li style="width: 25%;">
                <a @click="queryByStatus(3)"><i><img src="static/images/receive.png"></i> <span>待收货<p
                        class="cart_num">{{count3}}</p></span></a>
            </li>
            <li style="width: 25%;">
                <a @click="queryByStatus(4)"><i><img src="static/images/comment.png"></i> <span>待评价<p
                        class="cart_num">{{count4}}</p></span></a>
            </li>
            <li style="width: 25%;">
                <a @click="queryByStatus(6)"><i><img src="static/images/comment.png"></i> <span>已关闭<p
                        class="cart_num">{{count6}}</p></span></a>
            </li>
        </ul>
    </div>

    <div class="box-container-bottom" style="margin-bottom: 15px;"></div>

    <div class="m-logistics">
        <div class="s-bar"><i class="s-icon"></i></div>
        <div class="s-content">
            <ul class="lg-list"></ul>
            <table class="table">
                <tr>
                    <td>序号</td>
                    <td>订单商品</td>
                    <td>订单状态</td>
                    <td>时间</td>
                    <td>操作</td>
                </tr>
                <template v-for="(order,index) in orders">
                    <tr>
                        <td>{{index + 1}}</td>
                        <!-- <td>{{order.untitled.substring(0, order.untitled.length - 1)}}</td> -->
                        <td>
                            <span v-if="order.status == '1'">待付款</span>
                            <span v-else-if="order.status == '2'">待发货</span>
                            <span v-else-if="order.status == '3'">待收货</span>
                            <span v-else-if="order.status == '4'">待评价</span>
                            <span v-else-if="order.status == '5'">已完成</span>
                            <span v-else-if="order.status == '6'">已关闭</span>
                        </td>
                        <td>{{order.createTime}}</td>
                        <td>
                            <template v-if="order.status == '1'">
                                <button class="btn btn-success btn-xs">去支付</button>
                                <button class="btn btn-danger btn-xs" @click="cancelOrder" :data-id="order.orderId">
                                    取消订单
                                </button>
                            </template>
                            <template v-if="order.status == '2'">
                                <button class="btn btn-danger btn-xs">取消订单</button>
                            </template>
                            <template v-if="order.status == '3'">
                                <button class="btn btn-success btn-xs" @click="confirmOrder" :data-id="order.orderId">
                                    确认收货
                                </button>
                            </template>
                            <template v-if="order.status == '4'">
                                <button class="btn btn-success btn-xs" @click="gotoComment" :data-index="index">去评价
                                </button>
                            </template>
                            <template v-if="order.status == '5' || order.status == '6'">
                                <button class="btn btn-success btn-xs" @click="deleteOrder" :data-id="order.orderId">
                                    删除
                                </button>
                            </template>
                        </td>
                    </tr>
                </template>
                <tr>
                    <td colspan="5">
                        <!--分页 -->
                        <el-pagination background layout="prev, pager, next"
                                       :current-page="pageNum"
                                       :page-size="limit"
                                       :total="count" @current-change="pager"></el-pagination>
                    </td>
                </tr>
            </table>
        </div>
    </div>

</div>
<script type="text/javascript" src="static/js/cookie_utils.js"></script>
<script type="text/javascript" src="static/js/axios.min.js"></script>
<script type="text/javascript" src="static/js/vue.js"></script>
<!-- 引入组件库 -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script type="text/javascript">
    var layer;
    layui.use('layer', function () {
        layer = layui.layer;
    });
    var baseUrl = "http://localhost:8080/";
    var vm = new Vue({
        el: "#container",
        data: {
            token: "",
            pageNum: 1,
            limit: 5,
            userId: "",
            orders: [],
            count: 0,
            statusCount: [],
            count1: 0,
            count2: 0,
            count3: 0,
            count4: 0,
            count5: 0,
            count6: 0,
            status: null,
        },
        created: function () {
            console.log('这是订单页面')
            this.token = getCookieValue("token");
            this.userId = getCookieValue("userId");
            axios({
                method:"get",
                url: baseUrl + "order/statusCount/" + this.userId,
                headers: {
                    token: this.token
                },
            }).then(res => {
                if (res.data.code == 10000) {
                    this.statusCount = res.data.data;
                    for (var i in this.statusCount) {
                        if (this.statusCount[i].status == 1) {
                            this.count1 = this.statusCount[i].count
                        } else if (this.statusCount[i].status == 2) {
                            this.count2 = this.statusCount[i].count
                        } else if (this.statusCount[i].status == 3) {
                            this.count3 = this.statusCount[i].count
                        } else if (this.statusCount[i].status == 4) {
                            this.count4 = this.statusCount[i].count
                        } else if (this.statusCount[i].status == 5) {
                            this.count5 = this.statusCount[i].count
                        } else {
                            this.count6 = this.statusCount[i].count
                        }
                    }

                }
            })
            axios({
                url: baseUrl + "order/list",
                method: "get",
                headers: {
                    token: this.token
                },
                params: {
                    userId: this.userId,
                    pageNum: this.pageNum,
                    limit: this.limit
                }
            }).then((res) => {
                if (res.data.code == 10000) {
                    this.orders = res.data.data.list;
                    this.count = res.data.data.count;
                }
            });
        },

        methods: {
            pager: function (page) {
                this.pageNum = page;
                //1.加载页面，请求订单信息
                var obj = {
                    userId: this.userId,
                    pageNum: this.pageNum,
                    limit: this.limit
                };
                if (this.status != null) {
                    obj.status = this.status;
                }
                axios({
                    url: baseUrl + "order/list",
                    method: "get",
                    headers: {
                        token: this.token
                    },
                    params: obj
                }).then((res) => {
                    if (res.data.code == 10000) {
                        this.orders = res.data.data.list;
                        this.count = res.data.data.count;
                    }
                });
            },
            queryByStatus: function (status) {
                this.pageNum = 1;
                this.status = status;
                axios({
                    url: baseUrl + "order/list",
                    method: "get",
                    headers: {
                        token: this.token
                    },
                    params: {
                        userId: this.userId,
                        pageNum: this.pageNum,
                        limit: this.limit,
                        status: this.status
                    }
                }).then((res) => {
                    if (res.data.code == 10000) {
                        this.orders = res.data.data.list;
                        this.count = res.data.data.count;
                    }
                });
            },
            deleteOrder: function () {
                var orderId = event.srcElement.dataset.id;
                axios({
                    url: baseUrl + "order/deleteOrder",
                    method: "get",
                    headers: {
                        token: this.token
                    },
                    params: {
                        orderId: orderId,
                    }
                }).then((res) => {
                    if (res.data.code == 10000) {
                        layer.msg("刪除成功！！")
                        location.reload();
                    } else if (res.data.code = 99999) {
                        layer.msg("刪除订单失敗！！")
                    }
                });
            },
            cancelOrder: function () {
                var orderId = event.srcElement.dataset.id;
                axios({
                    url: baseUrl + "order/cancelOrder",
                    method: "get",
                    headers: {
                        token: this.token
                    },
                    params: {
                        orderId: orderId,
                        //关闭类型 4 为买家取消
                        closeType: 4,
                    }
                }).then((res) => {
                    layer.msg("取消订单成功！！");
                    location.reload();
                });
            },
            confirmOrder: function () {
                var orderId = event.srcElement.dataset.id;
                axios({
                    url: baseUrl + "order/confirmOrderById",
                    method: "get",
                    headers: {
                        token: this.token
                    },
                    params: {
                        orderId: orderId,
                        //订单状态 4 为去评价状态
                        status: 4,
                    }
                }).then((res) => {
                    if (res.data.code == 10000) {
                        layer.msg("确认收货成功！！")
                        location.reload();
                    } else if (res.data.code = 99999) {
                        layer.msg("确认成功失败！！")
                    }
                });
            },
            gotoComment: function (event) {
                var index = event.srcElement.dataset.index;
                var order = this.orders[index];
                localStorage.setItem("order", JSON.stringify(order));
                window.location.href = "user-commentadd.html";
            },


        }
    })
</script>
</body>
</html>
