<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0072)pay.html?selectedItemSpecIds=cake-1004-spec-1 -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport"
        content="width=device-width, initial-scale=1.0 ,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>结算页面</title>

    <link rel="shortcut icon" href="static/img/favicon.ico" type="image/x-icon" />
    <link href="static/css/amazeui.css" rel="stylesheet" type="text/css">
    <link href="static/css/demo.css" rel="stylesheet" type="text/css">
    <link href="static/css/cartstyle.css" rel="stylesheet" type="text/css">
    <link href="static/css/jsstyle.css" rel="stylesheet" type="text/css">
    <link href="static/css/lee.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="static/js/jquery.js"></script>
    <script type="text/javascript" src="static/js/vue.js"></script>

    <script type="text/javascript" src="static/js/qrcode.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>


</head>

<body style="overflow: visible;">
    <div id="container">

        <!--顶部导航条 -->
        <div class="am-container header">
            <ul class="message-l">
                <div class="topMessage">
                    <div class="menu-hd" v-if="isLogin">
                        {{username}},欢迎您
                    </div>
                    <div class="menu-hd" v-else>
                        亲，请<a href="login.html" target="_top" class="h">登录</a>
                        <a href="#" target="_top">免费注册</a>
                    </div>
                </div>
            </ul>
            <ul class="message-r">
                <div class="topMessage home">
                    <div class="menu-hd"><a href="index.html" target="_top" class="h">商城首页</a></div>
                </div>
                <div class="topMessage my-shangcheng">
                    <div class="menu-hd MyShangcheng"><a href="user-center.html" target="_top"><i
                                class="am-icon-user am-icon-fw"></i>个人中心</a>
                    </div>
                </div>
                <div class="topMessage mini-cart">
                    <div class="menu-hd"><a id="mc-menu-hd" href="shopcart.html" target="_top"><i
                                class="am-icon-shopping-cart  am-icon-fw"></i><span>购物车</span></a>
                    </div>
                </div>
                <div class="topMessage favorite">
                    <div class="menu-hd"><a href="#" target="_top"><i
                                class="am-icon-heart am-icon-fw"></i><span>收藏夹</span></a>
                    </div>
                </div>
            </ul>
        </div>

        <!--悬浮搜索框-->

        <div class="nav white">
            <div class="logo"><img src="static/images/logo.png" /></div>
            <div class="logoBig">
                <li><img src="static/images/logo.png" style="width: 50%;height: 50%" /></li>
            </div>

            <div class="search-bar pr">
                <a name="index_none_header_sysc" href="#"></a>
                <form>
                    <input id="searchInput" name="index_none_header_sysc" type="text" placeholder="搜索"
                        autocomplete="off">
                    <input id="ai-topsearch" class="submit am-btn" value="搜索" index="1" type="submit">
                </form>
            </div>
        </div>

        <div class="clear"></div>

        <div class="concent" style="margin-top: 35px;">
            <div class="paycont">
                <div class="address">
                    <h3>确认配送地址 </h3>
                    <div class="control selected">
                        <!-- <div class="tc-btn createAddr theme-login am-btn am-btn-danger">使用新地址</div>-->
                    </div>
                    <div class="clear"></div>
                    <ul>
                        <span style="">
                            <template v-for="(addr,index) in addrs">
                                <li :class="{'user-addresslist':true, 'defaultAddr':index==addrIndex}"
                                    style="margin-top: 6px;" @click="chooseAddr" :data-index="index">
                                    <div class="address-left">
                                        <div class="user DefaultAddr">
                                            <span class="buy-address-detail">
                                                <span class="buy-user">{{addr.receiverName}}</span>
                                                <span class="buy-phone">{{addr.receiverMobile}}</span>
                                            </span>
                                        </div>
                                        <div class="default-address DefaultAddr">
                                            <span class="buy-line-title buy-line-title-type">收货地址：</span>
                                            <span class="buy--address-detail">
                                                <span class="province">{{addr.province}}</span>
                                                <span class="city">{{addr.city}}</span>
                                                <span class="dist">{{addr.area}}</span>
                                                <span class="street">{{addr.addr}}</span>
                                            </span>
                                        </div>
                                        <ins class="deftip" v-if="addr.commonAddr==1">默认地址</ins>
                                    </div>
                                    <div class="address-right">
                                        <a href="person/address.html"><span
                                                class="am-icon-angle-right am-icon-lg"></span></a>
                                    </div>
                                    <div class="clear"></div>
                                    <div class="new-addr-btn">
                                        <a href="javascript:void(0);" class="hidden">设为默认</a> <span
                                            class="new-addr-bar hidden">|</span>
                                        <!--	<a href="javascript:void(0);">编辑</a> <span class="new-addr-bar">|</span>
                                                <a href="javascript:void(0);" @click="deleteAdder">删除</a>-->
                                    </div>
                                </li>
                            </template>

                        </span>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="logistics">
                    <h3>选择支付方式</h3>
                    <ul class="pay-list">
                        <li style="width: 100px; height: 40px; padding: 3px;" :class="{'selected':payType==1}"
                            @click="changePayType(1)">
                            <img src="static/images/weizhifu.jpg" style="width: 70px; height: 34px;">
                            <span></span>
                        </li>
                        <li style="width: 100px; height: 40px; padding: 3px;" :class="{'selected':payType==2}"
                            @click="changePayType(2)">
                            <img src="static/images/zhifubao.jpg" style="width: 70px; height: 34px;">
                            <span></span>
                        </li>
                    </ul>
                </div>
                <div class="clear"></div>
                <div class="concent">
                    <div id="payTable">
                        <h3>确认订单信息</h3>
                        <div class="cart-table-th">
                            <div class="wp">
                                <div class="th th-item">
                                    <div class="td-inner">商品信息</div>
                                </div>
                                <div class="th th-price">
                                    <div class="td-inner">单价</div>
                                </div>
                                <div class="th th-amount">
                                    <div class="td-inner">数量</div>
                                </div>
                                <div class="th th-sum">
                                    <div class="td-inner">金额</div>
                                </div>
                                <!-- <div class="th th-oplist">
                                 <div class="td-inner">配送方式</div>
                             </div>-->
                            </div>
                        </div>
                        <div class="clear"></div>
                        <div class="bundle  bundle-last">
                            <template v-for="sc in shopCarts">
                                <div class="bundle-main">
                                    <ul class="item-content clearfix">
                                        <div class="pay-phone">
                                            <li class="td td-item">
                                                <div class="item-pic">
                                                    <a href="item.html?itemId=cake-1004" target="_blank"
                                                        class="J_MakePoint"><img :src="'static/pimgs/'+sc.productImg"
                                                            class="itempic J_ItemImg"
                                                            style="width: 80px; height: 80px;"></a>
                                                </div>
                                                <div class="item-info">
                                                    <div class="item-basic-info">
                                                        <a href="item.html?itemId=cake-1004" target="_blank"
                                                            data-point="tbcart.8.11"
                                                            class="item-title J_MakePoint">{{sc.productName}}
                                                            {{sc.skuName}}</a>
                                                    </div>
                                                </div>
                                            </li>
                                            <li class="td td-info">
                                                <div class="item-props"><span class="sku-line">{{sc.skuProps}}</span>
                                                </div>
                                            </li>
                                            <li class="td td-price">
                                                <div class="item-price price-promo-promo">
                                                    <div class="price-content"><em
                                                            class="J_Price price-now">{{sc.sellPrice}}</em></div>
                                                </div>
                                            </li>
                                        </div>
                                        <li class="td td-amount">
                                            <div class="amount-wrapper ">
                                                <div class="item-amount "><span class="phone-title">购买数量</span>
                                                    <div class="sl">{{sc.cartNum}}</div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="td td-sum">
                                            <div class="td-inner"><em tabindex="0"
                                                    class="J_ItemSum number">{{sc.sellPrice * sc.cartNum}}</em>
                                            </div>
                                        </li>
                                    </ul>
                                    <div class="clear"></div>
                                </div>
                            </template>

                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="pay-total">
                    <div class="order-extra">
                        <div class="order-user-info">
                            <div id="holyshit257" class="memo"><label>买家留言：</label> <input type="text" title="选填, 可写备注"
                                    placeholder="选填, 可写备注" class="memo-input J_MakePoint c2c-text-default memo-close"
                                    v-model="orderRemark">
                                <div class="msg hidden J-msg">
                                    <p class="error">最多输入500个字符</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="clear"></div>
                </div>
                <div class="buy-point-discharge ">
                    <p class="price g_price ">
                        合计
                        <em class="pay-sum">¥{{totalPrice}}</em>
                    </p>
                </div>
                <div class="order-go clearfix">
                    <div class="pay-confirm clearfix">
                        <div class="box">
                            <div tabindex="0" id="holyshit267" class="realPay"><em class="t">实付款：</em>
                                <span class="price g_price ">
                                    <em id="J_ActualFee" class="style-large-bold-red ">¥{{totalPrice}}</em>
                                </span>
                            </div>
                            <div id="holyshit268" class="pay-address">
                                <p class="buy-footer-address"><span
                                        class="buy-line-title buy-line-title-type">寄送至：</span>
                                    <span class="buy--address-detail">
                                        <span class="province">{{addrs[addrIndex].province}}</span>
                                        <span class="city">{{addrs[addrIndex].city}}</span>
                                        <span class="dist">{{addrs[addrIndex].area}}</span>
                                        <span class="street">{{addrs[addrIndex].addr}}</span>
                                    </span>
                                </p>
                                <p class="buy-footer-address">
                                    <span class="buy-line-title">收货人：</span>
                                    <span class="buy-address-detail">
                                        <span class="buy-user">{{addrs[addrIndex].receiverName}}</span>
                                        <span class="buy-phone">{{addrs[addrIndex].receiverMobile}}</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <!-- <el-button type="text" @click="doSubmit">点击打开 Dialog</el-button> -->

                        <el-dialog style='text-align: left;' title="订单信息" :visible.sync="dialogVisible" width="30%" :before-close="handleClose">
                            <div style=" background: lightgrey; height: 600px; margin-top: 40px; padding: 15px;">
                                <div style=" background: white; height: 540px; margin: auto; padding-left: 50px;">
                                    <p>&nbsp;</p>
                                    <p>&nbsp;</p>
                                    <h3>订单编号: {{orderInfo.orderId}}</h3>
                                    <p>&nbsp;</p>
                                    <h3>订单金额:￥ {{orderInfo.totalPrice}}</h3>
                                    <hr/>
                                    <div id="div1">
                                        <div id="payQrcodeDiv" style="width: 200px; height: 200px;"></div>
                                    </div>
                                </div>
                            </div>

                            <span slot="footer" class="dialog-footer">
                                <el-button @click="dialogVisible = false">取 消</el-button>
                                <el-button type="primary" @click="dialogVisible = false">确 定</el-button>
                            </span>
                        </el-dialog>
                        <div id="holyshit269" class="submitOrder">
                            <div class="go-btn-wrap">
                                <a id="J_Go" href="javascript:void(0);" tabindex="0" title="点击此按钮，提交订单" class="btn-go"
                                    @click="doSubmit">提交订单</a>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>
            <!-- <div id="div1">
                <div id="payQrcodeDiv" style="width: 130px; height: 130px;margin-top: -324px; margin-left: 154px;">
                </div>
            </div> -->
            <div class="clear"></div>
        </div>

        <div class="footer">
            <div class="footer-hd">
                <p>
                    <a href="#">锋迷商城</a>
                    <b>|</b>
                    <a href="#">商城首页</a>
                    <b>|</b>
                    <a href="#">支付宝</a>
                    <b>|</b>
                    <a href="#">物流</a>
                </p>
            </div>
            <div class="footer-bd">
                <p>
                    <a href="#">关于我們</a>
                    <a href="#">合作伙伴</a>
                    <a href="#">联系我们</a>
                    <a href="#">网站地图</a>
                    <em>©L15970677836.com 版权所有</em>
                </p>
            </div>
        </div>

        <div class="theme-popover-mask" style="display: none; height: 763px;"></div>
        <div class="theme-popover" style="overflow: hidden; display: none;">
            <div class="am-cf am-padding">
                <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">新增地址</strong> / <small>Add
                        address</small></div>
            </div>
            <hr>
        </div>
        <div class="clear"></div>
    </div>
    <script type="text/javascript" src="static/js/utils.js"></script>
    <script type="text/javascript" src="static/js/cookie_utils.js"></script>
    <script type="text/javascript" src="static/js/axios.min.js"></script>
    <script type="text/javascript">
        var baseUrl = "http://localhost:8080/";

        var vm = new Vue({
            el: "#container",
            data: {
                dialogVisible: false,
                orderInfo: {},
                cartIds: "",
                addrs: [
                    {
                        "addrId": "",
                        "userId": "",
                        "receiverName": "",
                        "receiverMobile": "",
                        "province": "",
                        "city": "",
                        "area": "",
                        "addr": "",
                        "postCode": "",
                        "status": 0,
                        "commonAddr": 0,
                        "createTime": "",
                        "updateTime": ""
                    },
                ],
                shopCarts: [],
                addrIndex: 0,  //用户选择的地址的索引（默认值和当前用户地址的默认地址索引相同）
                totalPrice: 0,
                isLogin: false,
                username: "",
                userId: "",
                orderRemark: "",
                payType: 1,

            },
            mounted: function () {

            },
            created: function () {
                var token = getCookieValue("token");

                if (token != null && token != "") {
                    this.isLogin = true;
                    this.username = getCookieValue("username");
                    this.userId = getCookieValue("userId");
                }

                axios({
                    url: baseUrl + "useraddr/list",
                    methods: "get",
                    headers: {
                        token: token
                    },
                    params: {
                        userId: this.userId
                    },
                }
                ).then(res => {
                    if (res.data.code == 10009 || res.data.code == 10010) {
                        //跳转登录
                        window.location.href = encodeURI(login.html);
                    } else if (res.data.code == 10000) {
                        this.addrs = res.data.data;
                        console.log(this.addrs);
                        //this.addrIndex的值 等于 当前用户的默认收货地址的索引
                        for (var i = 0; i < this.addrs.length; i++) {
                            if (this.addrs[i].commonAddr == 1) {
                                this.addrIndex = i;
                            }
                        }
                    }
                });
                this.cartIds = getUrlParam("cids");
                axios({
                    url: baseUrl + "shoppingCart/listBycids",
                    methods: "get",
                    headers: {
                        token: token
                    },
                    params: {
                        cids: this.cartIds
                    },
                }
                ).then(res => {
                    if (res.data.code = 10000) {
                        this.shopCarts = res.data.data;
                        console.log(this.shopCarts);
                        for (var i = 0; i < this.shopCarts.length; i++) {
                            this.totalPrice = this.totalPrice + this.shopCarts[i].cartNum * this.shopCarts[i].sellPrice;
                        }
                    }
                });

            },
            methods: {
                handleClose(done) {
                    this.$confirm('确认关闭？')
                        .then(_ => {
                            done();
                        })
                        .catch(_ => { });
                },
                chooseAddr: function (event) {
                    this.addrIndex = event.srcElement.dataset.index;
                },
                changePayType: function (m) {
                    this.payType = m;
                },

                showOrder: function(){
                        //渲染二维码
                    var qrcode = new QRCode($("#payQrcodeDiv")[0], {
                        width: 200,
                        height: 200
                    });
                    console.log(this.orderInfo,'this.orderInfo')
                    qrcode.makeCode(this.orderInfo.payUrl);
                    var oid = this.orderInfo.orderId;
                    var i = setInterval(function () {
                        console.log("-----");
                        var url = baseUrl + "order/status/" + oid;
                        axios({
                            url: url,
                            method: "get",
                            headers: {
                                token: getCookieValue("token")
                            }
                        }).then((res) => {
                            if (res.data.data == "2") {
                                $("#div1").html("<label style='font-size:20px; color:green'>订单支付完成！</label>");
                                clearInterval(i);
                                window.setTimeout(function () {
                                    window.location.href ="shopcart.html";
                                },3000);
                            }
                        });
                    }, 1000);
                },

                
                doSubmit: function () {
                    var cids = this.cartIds;
                    var address = this.addrs[this.addrIndex].province + " " + this.addrs[this.addrIndex].city + " "
                        + this.addrs[this.addrIndex].area + " " + this.addrs[this.addrIndex].addr;
                    var orders = {
                        "actualAmount": this.totalPrice,
                        "orderRemark": this.orderRemark,
                        "payType": this.payType,
                        "receiverAddress": address,
                        "receiverMobile": this.addrs[this.addrIndex].receiverMobile,
                        "receiverName": this.addrs[this.addrIndex].receiverName,
                        "totalAmount": this.totalPrice,
                        "userId": getCookieValue("userId")
                    }
                    axios({
                        url: baseUrl + "order/add",
                        method: "post",
                        headers: {
                            token: getCookieValue("token")
                        },
                        params: {
                            cids: this.cartIds
                        },
                        data: orders
                    }).then(res => {
                        if (res.data.code = 10000) {
                            var orderInfo = res.data.data;
                            orderInfo.totalPrice = this.totalPrice;
                            this.orderInfo = orderInfo;

                    this.dialogVisible = true
                            setTimeout(()=>{
                                this.showOrder()
                            },500)
                        } else if (res.data.code == 10009 || res.data.code == 10010) {
                            window.location.href = "index.html";
                        } else {
                            alert(res.msg);
                        }
                    })
                }

            }
        });

    </script>

</body>

</html>